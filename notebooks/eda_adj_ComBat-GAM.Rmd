---
title: "EDA: MS ComBat-GAM"
author: "Virgilio Gonzenbach"
date: "1/22/2021"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE, 
                      cache.path = 'cache/eda_ComBat-GAM/', 
                      fig.path = "figures/eda_ComBat-GAM/")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Objective

To visualize effects of ComBat-GAM applied on the MS data relative to the raw MS data.

```{r, include=FALSE}
library(tidyverse) # dplyr and ggplot
library(readxl)
library(psych) 
library(pander)
library(ggpubr)
library(reshape2)
source("src/pair_rois.R")

# Load data
HC_raw = read.csv('data/deriv/HC_data.csv', stringsAsFactors = TRUE)
HC_adj = read.csv('data/deriv/HC_data_adj-ComBat-GAM.csv', stringsAsFactors = TRUE)
MS_raw = read.csv('data/deriv/MS_data.csv', stringsAsFactors = TRUE)
MS_adj = read.csv('data/deriv/MS_data_adj-ComBat-GAM.csv', stringsAsFactors = TRUE)

# Filter out PNC
HC_raw = filter(HC_raw, site != "PNC")
HC_adj = filter(HC_adj, site != "PNC")

list_df = list(HC_raw, HC_adj, MS_raw, MS_adj)

# Load dictionary
dict = read_xlsx("data/MUSE_ROI_Dict.xlsx", 1) 
dict = dict[dict$ROI_INDEX %in% 2:300, ] # Shorten dictionary

# Rename ICV for readibility
for(i in 1:length(list_df)){
   colnames(list_df[[i]])[6] = "ICV"
} 

# Aggregate ROIs
prep_rois = function(df){
   library(dplyr)
   
   # Load dictionary
   dict = read_xlsx("data/MUSE_ROI_Dict.xlsx", 1)
   dict = dict[dict$ROI_INDEX %in% 2:300, ]
   WM_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "WM"])
   GM_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "GM"])
   VN_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "VN"])

   #n Load 
   sig_rois = readRDS('data/non_linear_rois.rds') # ROIs that exhibit nonlinear effects with age
   
   df = df %>% mutate(WM = rowSums(across(WM_indexes)),
                      GM = rowSums(across(GM_indexes)),
                      CSF = rowSums(across(VN_indexes)),
                      Brain.Stem = sig_rois[1],
                      Cerebellum.WM = rowSums(across(sig_rois[2:3])),
                      Ventral.DC = rowSums(across(sig_rois[4:5])),
                      Fornix = rowSums(across(sig_rois[6:7])),
                      Ant.Limb.Int.Capsule = rowSums(across(sig_rois[8:9])))
   
   # Prepare covariates: square age
   df = df %>% mutate(age2 = (age - mean(age))^2, .after = age)
   
   return(df)
}

list_df = list_df %>% lapply(prep_rois)

HC_raw = list_df[[1]]
HC_adj = list_df[[2]]
MS_raw = list_df[[3]]
MS_adj = list_df[[4]]

# prepare target variables
roi_small = paste0("X", dict$ROI_INDEX)
roi_big = colnames(list_df[[1]])[153:160]
```

## IMPORTANT

MS patients from the *HSC* site that were scanned in a *SIEMENSTIMTRIO* scanner were excluded from the current harmonization.

```{r}
img = png::readPNG('docs/batch_exclusion_MS.png')
grid::grid.raster(img)
```

## IMPORTANT (cont.)

The corresponding group in the Healthy Control data was similarly excluded when modeling site effects with ComBat-GAM. 

```{r}
img = png::readPNG('docs/batch_exclusion_HC.png')
grid::grid.raster(img)
```

## Datasets: MS
 
MS (dimensions):  

```{r, echo=TRUE}
dim(MS_adj)
```

MS (count by site)
```{r}
MS_adj %>% group_by(site) %>% count()
```

MS (count by sex)
```{r}
MS_adj %>% group_by(sex) %>% count(site)
```

Totals: Females = `r sum(MS_adj$sex == "FEMALE")`; Males = `r sum(MS_adj$sex == "MALE")`

## Datasets: HC

Dimensions HC (no PNC):

```{r}
dim(HC_adj)
```

Count per site: 
```{r}
HC_raw %>% group_by(site) %>% count()
```

Count by sex and site:
```{r}
HC_raw %>% group_by(site) %>% count(sex)
```

Totals: Females `r sum(HC_adj$sex == "FEMALE")`; Males `r sum(HC_adj$sex == "MALE")`

## Datasets: HC + MS

Dimensions (no PNC):

```{r}
dim(rbind(HC_adj, MS_adj))
```

Count per site: 
```{r}
rbind(HC_adj, MS_adj) %>% group_by(site) %>% count()
```

Count by sex and site:
```{r}
rbind(HC_adj, MS_adj) %>% group_by(site) %>% count(sex)
```

Totals: Females `r sum(HC_adj$sex == "FEMALE")`; Males `r sum(HC_adj$sex == "MALE")`

## Age across sites

```{r}
MS_raw %>% ggplot(aes(x=site, col=site, y=age)) + geom_boxplot() + facet_wrap(~sex) + xlab("Site") + ylab("Age") + ggtitle("Distribution of MS patients' age across sites")
```

## Site effects: MS raw

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
check_roi_site_fx = function(df, roi_names, mod_sex = TRUE, mod_interaction = TRUE){
   
   # Decide formula 
   if(mod_sex){
      if(mod_interaction){
         extract_p = function(x) anova(lm(x ~ sex + age + age2 + age*sex + age2*sex, data = df), 
                                       lm(x ~ sex + age + age2 + age*sex + age2*sex + site, data = df)
                                       )$`Pr(>F)`[2]
      } else {
         extract_p = function(x) anova(lm(x ~ sex + age + age2, data = df), 
                                       lm(x ~ sex + age + age2 + site, data = df)
                                       )$`Pr(>F)`[2]
      }
      
   }else{
      mod_interaction = FALSE # by necessity
      extract_p = function(x) anova(lm(x ~ age + age2, data = df), 
                                    lm(x ~ age + age2 + site, data = df) # x ~ sex + age + age*sex + age2 + age2*sex + site
                                 )$`Pr(>F)`[2] 
   }
   
   Ps = df %>% select(roi_names) %>% sapply(extract_p)
   p_count = c(sum(p.adjust(Ps, method = 'fdr') < 0.05),
               sum(p.adjust(Ps, method = 'bonferroni') < 0.05),
               sum(Ps < 0.05)
               )
   
   names(p_count) = c("FDR", "Bonferroni", "Uncorrected P")
   pander(p_count)
   
   invisible(Ps)
}
```


```{r, echo=TRUE}
# Full model
p = check_roi_site_fx(MS_raw, roi_small)
```

```{r}
# Without considering sex
p = check_roi_site_fx(MS_raw, roi_small, mod_sex = FALSE)
```


## Site effects: MS adj

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
# Full model
check_roi_site_fx(MS_adj, roi_small)
```

```{r}
# Without considering sex
p = check_roi_site_fx(MS_adj, roi_small, mod_sex = FALSE)
```

## Site effects: MS adj (Females)

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
filter(MS_adj, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE)
```

## Site effects: MS adj (Males)

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
filter(MS_adj, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE)
```

## Site effects: HC raw

```{r, echo=TRUE}
# Full model
p = check_roi_site_fx(HC_raw, roi_small)
```

```{r}
# Without considering sex
p = check_roi_site_fx(HC_raw, roi_small, mod_sex = FALSE)
```

## Site effects: HC adj

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
# Full model
check_roi_site_fx(HC_adj, roi_small)
```

```{r}
# Without considering sex
p = check_roi_site_fx(HC_adj, roi_small, mod_sex = FALSE)
```

## Site effects: HC adj (Females)

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
filter(HC_adj, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE)
```

## Site effects: HC adj (Males)

Number of ROIs showing a significant model difference due to accounting for site:

```{r}
filter(HC_adj, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE)
```

## Conclusions



## ICV: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## ICV: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Brain Stem: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Brain Stem: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Cerebellum WM: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Cerebellum WM: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Ventral DC: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Ventral DC: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Fornix: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Fornix: Raw vs Harmonized (adj for sex and age)

```{r}
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Ant. Limb Int. Capsule (ALIC): Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## Ant. Limb Int. Capsule (ALIC): Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## WM: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## WM: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## GM: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## GM: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## CSF: Raw vs Harmonized

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

## CSF: Raw vs Harmonized (adj for sex and age)

```{r}
# Boxplots
p_MS_raw = MS_raw %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("MS Raw")
p_MS_adj = MS_adj %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("MS Harmonized")
p_HC_raw = HC_raw %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("HC Raw")
p_HC_adj = HC_adj %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("HC Harmonized")

ggarrange(p_MS_raw, p_MS_adj, p_HC_raw, p_HC_adj, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```




