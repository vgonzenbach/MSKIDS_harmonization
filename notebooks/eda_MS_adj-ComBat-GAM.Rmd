---
title: "EDA: MS ComBat-GAM"
author: "Virgilio Gonzenbach"
date: "1/22/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE, 
                      cache.path = 'cache/eda_MS_adj-ComBat-GAM/', 
                      fig.path = "figures/eda_MS_adj-ComBat-GAM/")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Objective

To visualize effects of ComBat-GAM applied on the MS data relative to the raw MS data.

```{r, include=FALSE}
library(tidyverse) # dplyr and ggplot
library(readxl)
library(psych) 
library(stargazer)
library(pander)
library(ggpubr)
library(reshape2)

# Load data
df_raw = read.csv('data/deriv/MS_data.csv', stringsAsFactors = TRUE)
df_adj = read.csv('data/deriv/MS_data_adj-ComBat-GAM.csv', stringsAsFactors = TRUE)
dict = read_xlsx("data/MUSE_ROI_Dict.xlsx", 1)

# Improve readibility for ICV
colnames(df_raw)[6] = "ICV"
colnames(df_adj)[6] = "ICV"

# Shorten Dictionary
dict = dict[dict$ROI_INDEX %in% 2:300, ]

# Tissue filters
VN_filter = dict$TISSUE_SEG == "VN"
GM_filter = dict$TISSUE_SEG == "GM"
WM_filter = dict$TISSUE_SEG == "WM"

# Aggregate ROIs
rois_raw = df_raw[, 7:ncol(df_raw)]
df_raw$WM = rowSums(rois_raw[, WM_filter])
df_raw$GM = rowSums(rois_raw[, GM_filter])
df_raw$CSF = rowSums(rois_raw[, VN_filter])
df_raw$Brain.Stem = df_raw$X35

rois_adj = df_adj[, 7:ncol(df_adj)]
df_adj$WM = rowSums(rois_adj[, WM_filter])
df_adj$GM = rowSums(rois_adj[, GM_filter])
df_adj$CSF = rowSums(rois_adj[, VN_filter])
df_adj$Brain.Stem = df_adj$X35
```

## IMPORTANT

MS patients from the *HSC* site that were scanned in a *SIEMENSTIMTRIO* scanner were excluded from the current harmonization.

```{r}
img = png::readPNG('docs/batch_exclusion_MS.png')
grid::grid.raster(img)
```

The corresponding group in the Healthy Control data was similarly excluded when modeling site effects with ComBat-GAM. 

```{r}
img = png::readPNG('docs/batch_exclusion_HC.png')
grid::grid.raster(img)
```


## Dimensions

```{r, echo=TRUE}
dim(df_raw)
```

## Age across sites

```{r}
df_raw %>% ggplot(aes(x=site, col=site, y=age)) + geom_boxplot() + facet_wrap(~sex) + xlab("Site") + ylab("Age") + ggtitle("Distribution of MS patients' age across sites")
```

## Sex Across sites

```{r}
table(df_raw$sex, df_raw$site)
```


## Contribution of site variable

```{r}
## ANOVA of all regions
Ps = matrix(nrow=2, ncol=ncol(rois_raw))
colnames(Ps) = colnames(rois_raw)

# For raw data
l = rois_raw %>% lapply(function(x) anova(lm(x ~ sex + age + age*sex, data = df_raw),
                                      lm(x ~ sex + age + age*sex + site, data = df_raw)))

for(j in colnames(rois_raw)) Ps[1,j] = l[[j]]$`Pr(>F)`[2]

p = c(sum(Ps[1,] < 0.05),
      sum(p.adjust(Ps[1,], method = 'bonferroni') < 0.05),
      sum(p.adjust(Ps[1,], method = 'fdr') < 0.05))
names(p) = c("Raw (Uncorrected P)", "Raw (Bonferroni)", "Raw (FDR)")
p

# For adj data
l = rois_adj %>% lapply(function(x) anova(lm(x ~ sex + age + age*sex, data = df_adj),
                                          lm(x ~ sex + age + age*sex + site, data = df_adj)))

for(j in colnames(rois_adj)) Ps[2,j] = l[[j]]$`Pr(>F)`[2]

p = c(sum(Ps[2,] < 0.05),
      sum(p.adjust(Ps[2,], method = 'bonferroni') < 0.05),
      sum(p.adjust(Ps[2,], method = 'fdr') < 0.05))
names(p) = c("Harmonized (Uncorrected P)", "Harmonized (Bonferroni)", "Harmonized (FDR)")
p
```


## ICV: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = ICV, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## ICV: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(ICV ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```



```{r}
# Prepare ROIs to plot
source("src/pair_rois.R")
sig_rois = readRDS('data/non_linear_rois.rds')
df_raw = data.frame(df_raw, pair_rois(df_raw, sig_rois))
df_adj = data.frame(df_adj, pair_rois(df_adj, sig_rois))
```

## Brain Stem: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = Brain.Stem, color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Brain Stem: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(Brain.Stem ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Brain Stem") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Cerebellum WM: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = Cerebellum.WM, color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Cerebellum WM: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(Cerebellum.WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Cerebellum WM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Ventral DC: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = Ventral.DC, color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Ventral DC: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(Ventral.DC ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Ventral DC") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Fornix: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = Fornix, color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Fornix: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(Fornix ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("Fornix") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Ant. Limb Int. Capsule (ALIC): Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = Ant.Limb.Int.Capsule, color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## Ant. Limb Int. Capsule (ALIC): Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(Ant.Limb.Int.Capsule ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("ALIC") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## WM: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = WM, color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

\pagebreak

## WM: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(WM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("WM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## GM: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = GM, color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## GM: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(GM ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("GM") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## CSF: Raw vs Harmonized

```{r}
# Boxplots
p_raw = df_raw %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = CSF, color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```

## CSF: Raw vs Harmonized (adj for sex and age)

```{r}
# Visualize ICV All and MF
p_raw = df_raw %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("Raw")
p_adj = df_adj %>% ggplot(aes(x = site, y = resid(lm(CSF ~ age + sex + age*sex)), color = site)) + geom_boxplot() + ylab("CSF") + facet_wrap(~sex) + ggtitle("GAM harmonization")
ggarrange(p_raw, p_adj, nrow = 1, common.legend = TRUE, legend = "bottom")
```




