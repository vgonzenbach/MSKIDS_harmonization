---
title: 'MSKIDS: Exploratory Analysis and ComBat Harmonization with Healthy Controls"
  (Part 4: Adjusting for ICV, interactions and non-linear effects)'
author: "Virgilio Gonzenbach"
date: "11/20/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
```

```{r, include=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(neuroCombat)
library(FactoMineR)
library(factoextra)
library(ggpubr)

df = readRDS("data/deriv/HC_data.rds")
dict = read_xlsx("MUSE_ROI_Dict.xlsx", 1)
```

```{r prepare_data}
# Batch
batch = paste(df$site, df$scanner, sep = "-") %>% as.factor()

# Drop n=7 batch
df = df[batch != "HSC-SIEMENSTIMTRIO", ]
batch = batch[batch != "HSC-SIEMENSTIMTRIO"]
batch = droplevels(batch)

# Pick volumes
indexes = paste0("X", 1:300)
indexes = indexes[indexes %in% colnames(df)] # keep indexes that match a column name
```

## Age

```{r}
df %>% ggplot(aes(x = site, y = age, color = site)) + geom_boxplot() + ylab("Age") + xlab("Site") + facet_wrap(~sex)
```

Females older than males in HSC. 

## ICV

```{r}
df %>% ggplot(aes(x = site, y = X702, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex)

# anova comparison
anova(lm(X702 ~ sex + age, data=df), lm(X702 ~ sex + age + batch, data=df))
```

```{r include=FALSE}
# Harmonize ICV
mod = model.matrix(~ sex + age + age*sex, data = df)
resCombat = neuroCombat::neuroCombat(dat = t(df$X702), 
                                     batch = batch, 
                                     mod = mod,
                                     eb = FALSE,
                                     parametric= TRUE)
df$X702 = t(resCombat$dat.combat)
```

### Harmonized

```{r include=FALSE}
# Visualize again
df %>% ggplot(aes(x = site, y = X702, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex)

# Model
anova(lm(X702 ~ sex + age, data=df), lm(X702 ~ sex + age + batch, data=df))
```


#### Interaction

```{r}
# Interaction
lm(scale(X702) ~ sex + scale(age) + sex*scale(age) + batch, data=df) %>% summary()

# ICV vs age
df %>% ggplot(aes(x = age, y = X702)) + geom_point() + facet_wrap(~sex) + geom_smooth(method = "lm") + ylab("ICV") + ggtitle("ICV vs Age")

# Plot regressed out
e = resid(lm(X702 ~ sex + age, data=df))
df %>% ggplot(aes(x = site, y = e, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("Age and Sex reg.out")
```

#### Non-linearity

```{r}
# Nonlinear
lm(scale(X702) ~ sex + scale(age) + log(age) + scale(age^2) + batch, data=df) %>% summary()

# ICV vs age
df %>% ggplot(aes(x = age, y = X702)) + geom_point() + facet_wrap(~sex) + ylab("ICV") + ggtitle("ICV vs Age") +
  stat_smooth(aes(x = age, y = X702), method = "lm", formula = y ~ x + I(x^2), color = "blue") + 
  stat_smooth(aes(x = age, y = X702), method = "lm", formula = y ~ x + I(log(x)), color = "red")
  
  

stat_smooth(aes(y = y1),method = "lm", formula = y ~ x + I(x^2), size = 1) +
      stat_smooth(aes(y = y2),method = "lm", formula = y ~ x + I(x^2), size = 1, color = "red")



# Plot regressed out
e = resid(lm(X702 ~ sex + age + age^2 + age*sex + log(age), data=df))
p2 = df %>% ggplot(aes(x = site, y = e, color = site)) + geom_boxplot() + ylab("ICV") + facet_wrap(~sex) + ggtitle("Age, Sex and Log(Age) reg.out")

ggarrange(p1, p2, nrow = 1, common.legend = TRUE)
```


## Number of significant ANOVA after accounting for sites

For each of the 145 ROI volumes, two models were used:  
- Model 1: region ~ sex + age + ICV
- Model 2: region ~ sex + age + ICV + batch

```{r combat, include=FALSE}
## ComBat Harmonization

# All
mod = model.matrix(~sex + age, data = df)
resCombat = neuroCombat::neuroCombat(dat = t(df[,indexes]), 
                                     batch = batch, 
                                     mod = mod,
                                     eb = TRUE,
                                     parametric= TRUE)

harmon_df = df
harmon_df[, indexes] = t(resCombat$dat.combat)
```

```{r}
## ANOVA of all regions
Ps = matrix(nrow=2, ncol=length(indexes))
colnames(Ps) = indexes

# ANOVAs Ra
l = df[,indexes] %>% lapply(function(x) anova(lm(x ~ sex + age + X702, data=df), 
                                              lm(x ~ sex + age + X702 + batch, data=df)))
for(i in indexes) Ps[1,i] = l[[i]]$`Pr(>F)`[2]

# ANOVAs - Unad
l = harmon_df[,indexes] %>% lapply(function(x) anova(lm(x ~ sex + age + X702, data=df), 
                                                     lm(x ~ sex + age + X702 + batch, data=df)))
for(i in indexes) Ps[2,i] = l[[i]]$`Pr(>F)`[2]

p = rowSums(Ps < (0.05/145))
names(p) = c("Raw", "Combat")
p
```

## Non-linearity in PNC vs whole data


```{r}
# How many regions show nonlinear effects?
l = df %>% filter(site == "PNC") %>% select(indexes) %>% lapply(function(x) anova(lm(x ~ sex + age + age*sex + X702, data=df[df$site=="PNC",]),
                                                                              lm(x ~ sex + age + age*sex + log(age) + age^2 + X702, data=df[df$site=="PNC",])))

for(i in 1:length(indexes)) non_lin[i] = l[[i]]$`Pr(>F)`[2]

non_lin_ps = non_lin < (0.05/145)
non_lin_indexes = as.numeric(gsub(".*?([0-9]+).*", "\\1", indexes[non_lin_ps]))
```

How many regions show non-linear effects in PNC data alone?
Where are the nonlinear effects found?

```{r}
dict[dict$ROI_INDEX %in% non_lin_indexes,]
```

What is the magnitude of these effects and significance level?

```{r}
# What is the magnitude of these effects and significance level
l = df %>% filter(site == "PNC") %>% select(indexes[non_lin_ps]) %>% lapply(function(x) lm(scale(x) ~ sex + age + age*sex + scale(age^2) + scale(log(age)) + X702, data=df[df$site=="PNC",]))

effects = matrix(nrow = 5, ncol = 4) 
colnames(effects) = c("Poly", "P_Poly", "Log", "P_Log")
rownames(effects) = dict$ROI_NAME[dict$ROI_INDEX %in% non_lin_indexes]

for(i in 1:length(l)){
  print(summary(l[[i]])$coefficient)
  effects[i, 1] = summary(l[[i]])$coefficients[4,1]
  effects[i, 2] = summary(l[[i]])$coefficients[4,4]
  effects[i, 3] = summary(l[[i]])$coefficients[5,1]
  effects[i, 4] = summary(l[[i]])$coefficients[5,4]
  i = i + 1
}
```

The following `r sum(non_lin_ps)` regions show significant model differences when the non-linear terms are introduced: 

```{r}
dict[dict$ROI_INDEX %in% non_lin_indexes,]
```



## (Covariance) PCA

```{r pca}
resPCA = FactoMineR::PCA(harmon_df[,indexes], 
                         scale.unit = FALSE, 
                         graph = FALSE, 
                         ncp = 6)

resid = apply(harmon_df[,indexes], 2, function(x) resid(lm(x ~ df$X702)))
                                        
resPCA_icv = FactoMineR::PCA(resid, 
                         scale.unit = FALSE, 
                         graph = FALSE,
                         ncp = 6)

dat = data.frame(pc1 = resPCA$ind$coord[,1], 
                 pc2 = resPCA$ind$coord[,2], 
                 pc3 = resPCA$ind$coord[,3],
                 pc4 = resPCA$ind$coord[,4],
                 pc5 = resPCA$ind$coord[,5],
                 pc6 = resPCA$ind$coord[,6],
                 sex = df$sex,
                 age = df$age)

dat_combat = data.frame(pc1 = resPCA_icv$ind$coord[,1], 
                        pc2 = resPCA_icv$ind$coord[,2], 
                        pc3 = resPCA_icv$ind$coord[,3],
                        pc4 = resPCA_icv$ind$coord[,4],
                        pc5 = resPCA_icv$ind$coord[,5],
                        pc6 = resPCA_icv$ind$coord[,6],
                        sex = df$sex, 
                        age = df$age)

get_ctr = function(resPCA, dim){
  impt_var =  names(which(resPCA$var$contrib[,dim] > 100/145)) # which var contribute more than average: 100/145
  most_impt = sort(resPCA$var$contrib[impt_var, dim], decreasing =  TRUE)[1:7]
  index = as.numeric(gsub(".*?([0-9]+).*", "\\1", names(most_impt)))
  ctr = data.frame(ctr = unname(most_impt), index)

  ctr_df = cbind(contr = ctr[,1], dict[match(ctr$index, dict$ROI_INDEX),1:4])
  return(ctr_df)
}
fviz_screeplot(resPCA, ncp=30)
fviz_screeplot(resPCA_icv, ncp=30)
```

\pagebreak

## Components 1 and 2

- PC1: White matter
- PC2: Cerebellum

```{r pca_12}
# Variables
plot.PCA(resPCA_icv, choix = "var", cex = 1, autoLab = "yes")
print("Dim 1");get_ctr(resPCA_icv, dim = 1)
print("Dim 2");get_ctr(resPCA_icv, dim = 2)
```


```{r pca_batch_12}
# Ind, colored by batch
fviz_pca_ind(resPCA, geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_icv, geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC1 
```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc1) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc1,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc1,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc1) ~ batch + scale(age) + sex, data = dat_combat))
```

# PC2
```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc2) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc2,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc2,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc2) ~ batch + scale(age) + sex, data = dat_combat))
```


## Components 3 and 4

Plane describes:  
1. Frontal lobe WM + GM (Q1) vs other lobes WM (Q3)
1. ventricle volume (Q2) perpendicular to line from (1) 
```{r pca_34}
# Variables
plot.PCA(resPCA_icv, axes = c(3,4), choix = "var", cex = 1, autoLab = "yes")
print("Dim 3");get_ctr(resPCA_icv, dim = 3)
print("Dim 4");get_ctr(resPCA_icv, dim = 4)
```


```{r pca_batch_34}
# Ind, colored by batch
fviz_pca_ind(resPCA, axes=c(3,4), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_icv, axes=c(3,4), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC3

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc3) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc3,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc3,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc3) ~ batch + scale(age) + sex, data = dat_combat))
```

## PC4

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc4) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc4,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc4,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc4) ~ batch + scale(age) + sex, data = dat_combat))
```

## Components 5 and 6

PC5: Temporal vs Parietal Lobe
PC6: ?
```{r pca_56}
# Variables
plot.PCA(resPCA_icv, axes = c(5,6), choix = "var", cex = 1, autoLab = "yes")
print("Dim 5");get_ctr(resPCA_icv, dim = 5)
print("Dim 6");get_ctr(resPCA_icv, dim = 6)
```


```{r pca_batch_56}
# Ind, colored by batch
fviz_pca_ind(resPCA, axes=c(5,6), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_icv, axes=c(5,6), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC5

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc5) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc5,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)


```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc5,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc5) ~ batch + scale(age) + sex, data = dat_combat))
```

## PC6

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc6) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc6,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc6,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc6) ~ batch + scale(age) + sex, data = dat_combat))
```
