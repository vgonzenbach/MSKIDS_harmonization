---
title: "EDA: MS ComBat-GAM"
author: "Virgilio Gonzenbach"
date: "1/22/2021"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE, 
                      cache.path = 'cache/eval_adj_data/', 
                      fig.path = "figures/eval_adj_data/")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Objective

To visualize effects of ComBat-GAM applied on the MS data relative to the raw MS data.

```{r, include=FALSE}
library(tidyverse) # dplyr and ggplot
library(readxl)
library(psych) 
library(kableExtra)
library(pander)
library(ggpubr)
library(reshape2)

# Load data
HC_split = read.csv('data/deriv/HC_data_adj_ComBat-GAM_split-MF_eb-True.csv', stringsAsFactors = TRUE)
HC_whole = read.csv('data/deriv/HC_data_adj_ComBat-GAM_split-None_eb-True.csv', stringsAsFactors = TRUE)
MS_split = read.csv('data/deriv/MS_data_adj-ComBat-GAM_from-HC_split-MF_eb-True.csv', stringsAsFactors = TRUE)
MS_whole = read.csv('data/deriv/MS_data_adj-ComBat-GAM_from-HC_split-None_eb-True.csv', stringsAsFactors = TRUE)

# Filter out PNC
HC_split = filter(HC_split, site != "PNC")
HC_whole = filter(HC_whole, site != "PNC")

list_df = list(HC_split = HC_split, HC_whole = HC_whole, MS_split = MS_split, MS_whole = MS_whole)

# Load dictionary
dict = read_xlsx("data/MUSE_ROI_Dict.xlsx", 1) 
dict = dict[dict$ROI_INDEX %in% 2:300, ] # Shorten dictionary

# Rename ICV for readibility
for(i in 1:length(list_df)){
   colnames(list_df[[i]])[6] = "ICV"
} 

# Aggregate ROIs
prep_rois = function(df){
   library(dplyr)
   
   # Load dictionary
   dict = read_xlsx("data/MUSE_ROI_Dict.xlsx", 1)
   dict = dict[dict$ROI_INDEX %in% 2:300, ]
   WM_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "WM"])
   GM_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "GM"])
   VN_indexes = paste0("X", dict$ROI_INDEX[dict$TISSUE_SEG == "VN"])

   #n Load 
   sig_rois = readRDS('data/non_linear_rois.rds') # ROIs that exhibit nonlinear effects with age
   
   df = df %>% mutate(WM = rowSums(across(WM_indexes)),
                      GM = rowSums(across(GM_indexes)),
                      CSF = rowSums(across(VN_indexes)),
                      Brain.Stem = rowSums(across(sig_rois[1])),
                      Cerebellum.WM = rowSums(across(sig_rois[2:3])),
                      Ventral.DC = rowSums(across(sig_rois[4:5])),
                      Fornix = rowSums(across(sig_rois[6:7])),
                      Ant.Limb.Int.Capsule = rowSums(across(sig_rois[8:9])))
   
   # Prepare covariates: square age
   df = df %>% mutate(age2 = (age - mean(age))^2, .after = age)
   
   return(df)
}

list_df = list_df %>% lapply(prep_rois)

HC_split = list_df[[1]]
HC_whole = list_df[[2]]
MS_split = list_df[[3]]
MS_whole = list_df[[4]]

# prepare target variables
roi_small = paste0("X", dict$ROI_INDEX)
roi_big = colnames(list_df[[1]])[153:160]

saveRDS(list_df, "tmp/list_of_df.rds")
```

## IMPORTANT

MS patients from the *HSC* site that were scanned in a *SIEMENSTIMTRIO* scanner were excluded from the current harmonization.

```{r}
img = png::readPNG('docs/batch_exclusion_MS.png')
grid::grid.raster(img)
```

## IMPORTANT (cont.)

The corresponding group in the Healthy Control data was similarly excluded when modeling site effects with ComBat-GAM. 

```{r}
img = png::readPNG('docs/batch_exclusion_HC.png')
grid::grid.raster(img)
```

## Datasets: MS
 
MS (dimensions):  

```{r}
dim(MS_whole)
```

MS (count by site)
```{r}
MS_whole %>% group_by(site) %>% count() %>% pander()
```

MS (count by sex)
```{r}
MS_whole %>% group_by(sex) %>% count(site) %>% pander()
```

Totals: Females = `r sum(MS_whole$sex == "FEMALE")`; Males = `r sum(MS_whole$sex == "MALE")`

## Datasets: HC

Dimensions HC (no PNC):

```{r}
dim(HC_whole)
```

Count per site: 
```{r}
HC_split %>% group_by(site) %>% count() %>% kable()
```

Count by sex and site:
```{r}
HC_split %>% group_by(site) %>% count(sex) %>% kable()
```

Totals: Females `r sum(HC_whole$sex == "FEMALE")`; Males `r sum(HC_whole$sex == "MALE")`

## Datasets: HC + MS

Dimensions (no PNC):

```{r}
dim(rbind(HC_whole, MS_whole))
```

Count per site: 
```{r}
rbind(HC_whole, MS_whole) %>% group_by(site) %>% count() %>% kable()
```

Count by sex and site:
```{r}
rbind(HC_whole, MS_whole) %>% group_by(site) %>% count(sex) %>% kable()
```

Totals: Females `r sum(HC_whole$sex == "FEMALE")`; Males `r sum(HC_whole$sex == "MALE")`

## Age across sites [MS]

```{r}
MS_split %>% ggplot(aes(x=site, col=site, y=age)) + geom_boxplot() + facet_wrap(~sex) + xlab("Site") + ylab("Age") + ggtitle("Age distribution of MS patients across sites")
```

## Age across sites [HC]

```{r}
HC_split %>% ggplot(aes(x=site, col=site, y=age)) + geom_boxplot() + facet_wrap(~sex) + xlab("Site") + ylab("Age") + ggtitle("Age distribution of Healthy Controls across sites")
```

## Harmonization Approach

Adjusted data are shown for the following approach:  
* Split the HC data into males and females  
* Run ComBat-GAM on both datasets.  
* Apply resulting models to MS data in males and females respectively.  

## Checking site effects

Site effects were tested with different models and data splits.

For full datasets, either sex and interactions terms (x ~ sex + age + age2 + age *x* sex + age2 *x* sex) were included or only age terms (x ~ age + age2).

For datasets split by sex, only age terms were included.

## Site effects: MS [split M/F]

```{r}
check_roi_site_fx = function(df, roi_names, mod_sex = TRUE, mod_interaction = TRUE){
   
   # Decide formula 
   if(mod_sex){
      if(mod_interaction){
         extract_p = function(x) anova(lm(x ~ sex + age + age2 + age*sex + age2*sex, data = df), 
                                       lm(x ~ sex + age + age2 + age*sex + age2*sex + site, data = df)
                                       )$`Pr(>F)`[2]
      } else {
         extract_p = function(x) anova(lm(x ~ sex + age + age2, data = df), 
                                       lm(x ~ sex + age + age2 + site, data = df)
                                       )$`Pr(>F)`[2]
      }
      
   }else{
      mod_interaction = FALSE # by necessity
      extract_p = function(x) anova(lm(x ~ age + age2, data = df), 
                                    lm(x ~ age + age2 + site, data = df) # x ~ sex + age + age*sex + age2 + age2*sex + site
                                 )$`Pr(>F)`[2] 
   }
   
   Ps = df %>% select(all_of(roi_names)) %>% sapply(extract_p)
   p_count = c(sum(p.adjust(Ps, method = 'fdr') < 0.05),
               sum(p.adjust(Ps, method = 'bonferroni') < 0.05),
               sum(Ps < 0.05)
               )
   
   names(p_count) = c("FDR", "Bonferroni", "Uncorrected P")
   invisible(p_count)
}
```


Number of ROIs showing site effects:

Full covariate model: 
```{r}
# Full model
check_roi_site_fx(MS_split, roi_small) %>% pander()
```

Sex not considered:
```{r}
# Without considering sex
check_roi_site_fx(MS_split, roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects: MS [no split]

Full covariate model: 
```{r}
# Full model
check_roi_site_fx(MS_whole, roi_small) %>% pander()
```


Sex not considered:
```{r}
# Without considering sex
check_roi_site_fx(MS_whole, roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects by sex: MS [M/F split]

Females: 

```{r}
filter(MS_whole, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

Males:

```{r}
filter(MS_whole, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects by sex: MS [no split]

Females: 

```{r}
filter(MS_whole, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

Males:

```{r}
filter(MS_whole, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects: HC [split M/F]

Full model: 

```{r}
# Full model
check_roi_site_fx(HC_split, roi_small) %>% pander()
```

Sex not considered:

```{r}
# Without considering sex
check_roi_site_fx(HC_split, roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects: HC [no split]

Number of ROIs showing site effects:

Full model: 
```{r}
# Full model
check_roi_site_fx(HC_whole, roi_small) %>% pander()
```

Sex not considered:
```{r}
# Without considering sex
check_roi_site_fx(HC_whole, roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects by sex: HC [split M/F]

Females:

```{r}
filter(HC_whole, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

Males:

```{r}
filter(HC_whole, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

## Site effects by sex: HC [no split]

Females:

```{r}
filter(HC_whole, sex == "FEMALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

Males:

```{r}
filter(HC_whole, sex == "MALE") %>%  check_roi_site_fx(roi_small, mod_sex = FALSE) %>% pander()
```

## Conclusions

Harmonization seems to be effective for Females in HC and MS.

With the current approach, MS Males are not harmonized correctly.




