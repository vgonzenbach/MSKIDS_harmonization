---
title: 'MSKIDS: Exploratory Analysis and ComBat Harmonization with Healthy Controls"
  (Part 3: Normalization of Harmonized Volumes)'
author: "Virgilio Gonzenbach"
date: "11/20/2020"
output:
  pdf_document: default
  html_document: default
---
Goal: to examine the effect of normalization, i.e. dividing by intracraneal volume (ICV), on harmonized volumes. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
```

```{r, include=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(neuroCombat)
library(FactoMineR)
library(factoextra)
library(ggpubr)

df = readRDS("data/deriv/HC_data.rds")
dict = read_xlsx("MUSE_ROI_Dict.xlsx", 1)
```

```{r prepare_data}
# Batch
batch = paste(df$site, df$scanner, sep = "-") %>% as.factor()

# Drop n=7 batch
df = df[batch != "HSC-SIEMENSTIMTRIO", ]
batch = batch[batch != "HSC-SIEMENSTIMTRIO"]
batch = droplevels(batch)

# Pick volumes
indexes = paste0("X", 1:300)
indexes = indexes[indexes %in% colnames(df)] # keep indexes that match a column name
norm_vol = data.frame(batch, df[,indexes] / df$X702)

# ANOVAs for Raw Data
Ps = matrix(nrow=2, ncol=length(indexes))
colnames(Ps) = indexes

l = norm_vol[,-1] %>% lapply(function(x) anova(lm(x ~ df$sex + df$age), lm(x~df$sex + df$age + batch)))
for(i in indexes) Ps[1,i] = l[[i]]$`Pr(>F)`[2]
```

```{r combat, include=FALSE}
## ComBat Harmonization
library(neuroCombat)

# All
mod = model.matrix(~sex + age, data = df)
resCombat = neuroCombat::neuroCombat(dat = t(df[,indexes]), 
                                     batch = batch, 
                                     mod = mod,
                                     eb = TRUE,
                                     parametric= TRUE)

harmon_df = data.frame(batch, t(resCombat$dat.combat) / df$X702)

# ANOVAs - Unadj
l = harmon_df[,-1] %>% lapply(function(x) anova(lm(x ~ df$sex + df$age), lm(x ~ batch + df$sex + df$age)))
for(i in indexes) Ps[2,i] = l[[i]]$`Pr(>F)`[2]
```



### Number of significant ANOVA after accounting for sites

For each of the 145 ROI volumes, two models were used:  
- Model 1: region ~ sex + age
- Model 2: region ~ sex + age + batch

```{r}
p = rowSums(Ps < (0.05/145))
names(p) = c("Raw", "Combat")
p
```

*Compare this with non-normalized values from the previous report*

```{r out.width=300}
knitr::include_graphics("non-normalized_anovas.png")
```



## (Covariance) PCA

```{r pca}
resPCA = FactoMineR::PCA(norm_vol, 
                         scale.unit = FALSE, 
                         graph = FALSE, 
                         quali.sup = 1,
                         ncp = 8)

resPCA_Combat = FactoMineR::PCA(harmon_df, 
                         scale.unit = FALSE, 
                         graph = FALSE, 
                         quali.sup = 1,
                         ncp = 8)

dat = data.frame(pc1 = resPCA$ind$coord[,1], 
                 pc2 = resPCA$ind$coord[,2], 
                 pc3 = resPCA$ind$coord[,3],
                 pc4 = resPCA$ind$coord[,4],
                 pc5 = resPCA$ind$coord[,5],
                 pc6 = resPCA$ind$coord[,6],
                 pc7 = resPCA$ind$coord[,7],
                 pc8 = resPCA$ind$coord[,8],
                 sex = df$sex,
                 age = df$age)

dat_combat = data.frame(pc1 = resPCA_Combat$ind$coord[,1], 
                        pc2 = resPCA_Combat$ind$coord[,2], 
                        pc3 = resPCA_Combat$ind$coord[,3],
                        pc4 = resPCA_Combat$ind$coord[,4],
                        pc5 = resPCA_Combat$ind$coord[,5],
                        pc6 = resPCA_Combat$ind$coord[,6],
                        pc7 = resPCA_Combat$ind$coord[,7],
                        pc8 = resPCA_Combat$ind$coord[,8],
                        sex = df$sex, 
                        age = df$age)

get_ctr = function(resPCA, dim){
  impt_var =  names(which(resPCA$var$contrib[,dim] > 100/145)) # which var contribute more than average: 100/145
  most_impt = sort(resPCA$var$contrib[impt_var, dim], decreasing =  TRUE)[1:7]
  index = as.numeric(gsub(".*?([0-9]+).*", "\\1", names(most_impt)))
  ctr = data.frame(ctr = unname(most_impt), index)

  ctr_df = cbind(contr = ctr[,1], dict[match(ctr$index, dict$ROI_INDEX),1:4])
  return(ctr_df)
}
fviz_screeplot(resPCA, ncp=30)
```

\pagebreak

## Components 1 and 2

- PC1: White matter
- PC2: Cerebellum

```{r pca_12}
# Variables
plot.PCA(resPCA_Combat, choix = "var", cex = 1, autoLab = "yes")
print("Dim 1");get_ctr(resPCA_Combat, dim = 1)
print("Dim 2");get_ctr(resPCA_Combat, dim = 2)
```


```{r pca_batch_12}
# Ind, colored by batch
fviz_pca_ind(resPCA, geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_Combat, geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC1 
```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc1) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc1,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc1,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc1) ~ batch + scale(age) + sex, data = dat_combat))
```

# PC2
```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc2) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc2,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc2,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc2) ~ batch + scale(age) + sex, data = dat_combat))
```


## Components 3 and 4

Plane describes:  
1. Frontal lobe WM + GM (Q1) vs other lobes WM (Q3)
1. ventricle volume (Q2) perpendicular to line from (1) 
```{r pca_34}
# Variables
plot.PCA(resPCA_Combat, axes = c(3,4), choix = "var", cex = 1, autoLab = "yes")
print("Dim 3");get_ctr(resPCA_Combat, dim = 3)
print("Dim 4");get_ctr(resPCA_Combat, dim = 4)
```


```{r pca_batch_34}
# Ind, colored by batch
fviz_pca_ind(resPCA, axes=c(3,4), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_Combat, axes=c(3,4), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC3

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc3) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc3,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc3,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc3) ~ batch + scale(age) + sex, data = dat_combat))
```

## PC4

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc4) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc4,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc4,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc4) ~ batch + scale(age) + sex, data = dat_combat))
```

## Components 5 and 6

PC5: Temporal vs Parietal Lobe
PC6: ?
```{r pca_56}
# Variables
plot.PCA(resPCA_Combat, axes = c(5,6), choix = "var", cex = 1, autoLab = "yes")
print("Dim 5");get_ctr(resPCA_Combat, dim = 5)
print("Dim 6");get_ctr(resPCA_Combat, dim = 6)
```


```{r pca_batch_56}
# Ind, colored by batch
fviz_pca_ind(resPCA, axes=c(5,6), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_Combat, axes=c(5,6), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC5

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc5) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc5,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)


```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc5,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc5) ~ batch + scale(age) + sex, data = dat_combat))
```

## PC6

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc6) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc6,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc6,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc6) ~ batch + scale(age) + sex, data = dat_combat))
```

## Components 7 and 8

```{r pca_78}
# Variables
plot.PCA(resPCA_Combat, axes = c(7,8), choix = "var", cex = 1, autoLab = "yes")
print("Dim 7");get_ctr(resPCA_Combat, dim = 7)
print("Dim 8");get_ctr(resPCA_Combat, dim = 8)
```


```{r pca_batch_78}
# Ind, colored by batch
fviz_pca_ind(resPCA, axes=c(7,8), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Raw")

fviz_pca_ind(resPCA_Combat, axes=c(7,8), geom = "point", 
             col.ind = batch, 
             alpha.ind = 0.4) + ggtitle("Combat")
```

## PC7

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc7) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc7,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc7,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc7) ~ batch + scale(age) + sex, data = dat_combat))
```

## PC8

```{r, echo=FALSE}
# Raw
print("RAW");   summary(glm(scale(pc8) ~ batch + scale(age) + sex, data = dat))
dat %>% 
  ggplot(aes(x=age, y=pc8,col=batch)) + 
  geom_point(alpha = 0.5) + ggtitle("Raw") + 
  geom_smooth(method="lm") + facet_wrap(~sex)
```

```{r, echo=FALSE}
# Combat
dat_combat %>% ggplot(aes(x=age, y=pc8,col=batch)) + geom_point(alpha = 0.5) + facet_wrap(~sex) + ggtitle("Combat") + geom_smooth(method="lm")

print("COMBAT");summary(glm(scale(pc8) ~ batch + scale(age) + sex, data = dat_combat))
```

### ROI plots

```{r prep_plots, include=FALSE}
# Sort ROI by volume
mean_vol = colMeans(norm_vol[,-1])
quantiles = mean_vol %>% quantile(seq(0, 1, 0.1))

group_index = list(vector("character"), 
                   vector("character"), 
                   vector("character"), 
                   vector("character"), 
                   vector("character"),
                   vector("character"), 
                   vector("character"), 
                   vector("character"), 
                   vector("character"), 
                   vector("character"))

for(i in 2:length(quantiles)){
  if(i != length(quantiles)){
    group_index[[i-1]] = names(which(mean_vol >= quantiles[i-1] & mean_vol < quantiles[i]))
  }else{
    group_index[[i-1]] = names(which(mean_vol >= quantiles[i-1] & mean_vol <= quantiles[i]))
  }
}

## Boxplots
plot_roi = function(dat1, dat2, group_index){
  plots = list()
  j = 1
  for(i in group_index){
    p1 = dat1 %>% select(batch, i) %>% 
      gather(region, volume, -batch) %>% 
      ggplot(aes(x=region, y=volume, color=batch)) + geom_boxplot() + 
      theme(axis.text.x=element_text(size=7, angle=45),
        axis.ticks.x=element_blank()) + ggtitle("Raw")
    
    p2 = dat2 %>% select(batch, i) %>% 
      gather(region, volume, -batch) %>% 
      ggplot(aes(x=region, y=volume, color=batch)) + geom_boxplot() + 
      theme(axis.text.x=element_text(size=7, angle=45), 
        axis.ticks.x=element_blank()) + ggtitle("Combat")
    
    
    plots[[j]] = ggarrange(p1, p2, ncol = 1, common.legend = TRUE, legend = "bottom")
    j = j + 1
  }
  return(plots)
}

roi_plots = plot_roi(norm_vol, harmon_df, group_index)
```

```{r roi_plots}
roi_plots
```
